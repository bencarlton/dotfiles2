{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash

{{ template "shared_script_utils.bash" . }}

_hasJQ_ # Confirm we have jq installed

VERBOSE=false
PACKAGE_NAME="otree"
REPOSITORY="fioncat/otree"

header "Verify ${PACKAGE_NAME} installation and check for updates"

# Fetch the API response once and store it in a variable
API_RESPONSE=$(curl -s "https://api.github.com/repos/${REPOSITORY}/releases/latest")

# Extract the required information from the stored API response
LATEST_VERSION=$(echo "${API_RESPONSE}" | jq -r .tag_name | sed 's/v//g')
IS_PRE_RELEASE=$(echo "${API_RESPONSE}" | jq -r .prerelease)
IS_DRAFT=$(echo "${API_RESPONSE}" | jq -r .draft)
RELEASE_NOTES=$(echo "${API_RESPONSE}" | jq -r .html_url)

info "Latest version is ${LATEST_VERSION}"
debug "Is pre-release: ${IS_PRE_RELEASE}"
debug "Is draft: ${IS_DRAFT}"
debug "Release Notes: ${RELEASE_NOTES}"

if [[ $(command -v ${PACKAGE_NAME}) ]]; then
    CURRENT_VERSION=$(${PACKAGE_NAME} --version | awk '{print $2}')

    info "Local version: ${CURRENT_VERSION}"

    if [[ ${CURRENT_VERSION} == "${LATEST_VERSION}" ]]; then
        success "${PACKAGE_NAME} is already up to date"
        _safeExit_ 0
    fi

    if [[ ${IS_PRE_RELEASE} == "true" ]] || [[ ${IS_DRAFT} == "true" ]]; then
        notice "Latest version is a pre-release or draft. Skipping update."
        _safeExit_ 0
    fi
fi

{{ if not (eq .chezmoi.arch "amd64") }}
warning "${PACKAGE_NAME} is not available on {{ .chezmoi.arch }} systems"
_safeExit_ 0
{{ end }}

_makeTempDir_ "$(basename "$0")"
pushd "${TMP_DIR}" &>/dev/null || exit

info "Downloading ${PACKAGE_NAME} version ${LATEST_VERSION}"

curl -Lo binary.tar.gz "https://github.com/fioncat/otree/releases/download/v${LATEST_VERSION}/otree-x86_64-unknown-linux-musl.tar.gz"

tar xf binary.tar.gz ${PACKAGE_NAME}

# Move the binary to the local bin directory
if [[ -d "${HOME}/.local/bin" ]]; then
    mv ${PACKAGE_NAME} "${HOME}/.local/bin"
else
    mkdir -p "${HOME}/.local/bin"
    mv ${PACKAGE_NAME} "${HOME}/.local/bin"
fi

success "${PACKAGE_NAME} v${LATEST_VERSION} installed to ${HOME}/.local/bin/${PACKAGE_NAME}"
info "Release notes: ${RELEASE_NOTES}"

popd &>/dev/null || exit
_safeExit_
{{ end }}
